import React, { useEffect, useMemo, useState } from "https://esm.sh/react@18.3.1";
import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";

const h = React.createElement;
const API_BASE = `${window.location.origin}/api`;

const ARTIFACT_TYPES = [
  {
    name: "envelope",
    summary: "Serialized payload envelopes emitted by upstream subsystems.",
  },
  {
    name: "guard_receipt",
    summary: "Guard receipts emitted by upstream audit pipelines.",
  },
  {
    name: "execution_manifest",
    summary: "Execution manifests generated by external orchestration layers.",
  },
  {
    name: "audits",
    summary: "Audit and log bundles published by external systems.",
  },
];

function SectionCard({ title, description, children }) {
  return h(
    "section",
    { className: "rounded-xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40" },
    h(
      "div",
      { className: "mb-4 flex flex-col gap-2 md:flex-row md:items-center md:justify-between" },
      h("div", {}, h("h2", { className: "text-xl font-semibold" }, title), description && h("p", { className: "text-sm text-slate-400" }, description)),
    ),
    children,
  );
}

function useApi(path, fallback) {
  const [state, setState] = useState({ loading: true, data: fallback, error: null });

  useEffect(() => {
    let active = true;
    fetch(`${API_BASE}${path}`)
      .then((resp) => resp.json())
      .then((data) => {
        if (active) setState({ loading: false, data, error: null });
      })
      .catch((error) => {
        console.error("Failed to load", path, error);
        if (active) setState({ loading: false, data: fallback, error });
      });
    return () => {
      active = false;
    };
  }, [path, fallback]);

  return state;
}

function StatusSummary({ status }) {
  if (status.loading) {
    return h("p", { className: "text-sm text-slate-400" }, "Loading status...");
  }
  if (status.error) {
    return h("p", { className: "text-sm text-rose-300" }, "Status unavailable.");
  }

  return h(
    "div",
    { className: "grid gap-3 text-sm text-slate-300 md:grid-cols-2" },
    h("div", {}, h("span", { className: "text-slate-500" }, "Version"), h("div", { className: "font-medium" }, status.data.version)),
    h("div", {}, h("span", { className: "text-slate-500" }, "Config directory"), h("div", { className: "font-medium" }, status.data.config_dir)),
  );
}

function ArtifactList() {
  const rows = useMemo(
    () =>
      ARTIFACT_TYPES.map((artifact) =>
        h(
          "div",
          { key: artifact.name, className: "rounded-lg border border-slate-800 bg-slate-950/60 p-4" },
          h("p", { className: "text-sm font-semibold text-slate-200" }, artifact.name),
          h("p", { className: "mt-1 text-xs text-slate-400" }, artifact.summary),
        ),
      ),
    [],
  );
  return h("div", { className: "grid gap-3 md:grid-cols-2" }, rows);
}

function PluginList({ plugins }) {
  if (plugins.loading) {
    return h("p", { className: "text-sm text-slate-400" }, "Loading plugins...");
  }
  if (plugins.error) {
    return h("p", { className: "text-sm text-rose-300" }, "Plugin inventory unavailable.");
  }
  if (!plugins.data.plugins || plugins.data.plugins.length === 0) {
    return h("p", { className: "text-sm text-slate-400" }, "No plugins registered.");
  }
  return h(
    "ul",
    { className: "flex flex-col gap-2 text-sm text-slate-300" },
    plugins.data.plugins.map((plugin) =>
      h(
        "li",
        { key: plugin.name || plugin.path, className: "rounded-lg border border-slate-800 bg-slate-950/60 p-3" },
        h("p", { className: "font-medium" }, plugin.name || "Unnamed plugin"),
        plugin.path && h("p", { className: "text-xs text-slate-500" }, plugin.path),
      ),
    ),
  );
}

function App() {
  const status = useApi("/status", {});
  const plugins = useApi("/plugins", { plugins: [] });

  return h(
    "div",
    { className: "min-h-screen bg-slate-950 text-slate-100" },
    h(
      "main",
      { className: "mx-auto flex w-full max-w-6xl flex-col gap-6 px-6 py-10" },
      h(
        "header",
        { className: "flex flex-col gap-3" },
        h("p", { className: "text-xs font-semibold uppercase tracking-[0.3em] text-slate-500" }, "BLUX Commander"),
        h("h1", { className: "text-3xl font-semibold" }, "Read-only observability cockpit"),
        h(
          "p",
          { className: "max-w-2xl text-sm text-slate-400" },
          "Commander surfaces observability artifacts produced by other systems. It does not generate artifacts or perform actions.",
        ),
      ),
      h(
        SectionCard,
        {
          title: "Status",
          description: "Live health summary from the read-only cockpit.",
        },
        h(StatusSummary, { status }),
      ),
      h(
        SectionCard,
        {
          title: "Artifact inventory",
          description: "Artifact categories rendered by the cockpit.",
        },
        h(ArtifactList),
      ),
      h(
        SectionCard,
        {
          title: "Plugins",
          description: "Registered read-only integrations and views.",
        },
        h(PluginList, { plugins }),
      ),
    ),
  );
}

const root = createRoot(document.getElementById("root"));
root.render(h(App));
